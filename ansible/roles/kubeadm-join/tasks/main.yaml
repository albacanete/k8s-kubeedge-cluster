---
# let root interact with the cluster
- name: create root .kube directory
  file:
    path: /root/.kube
    state: directory
    mode: 0755

- name: copy config to root home
  copy:
    src: /tmp/kube-config
    dest: /root/.kube/config

# let user interact with the cluster
- name: create user .kube directory
  file:
    path: /home/{{ user }}/.kube
    state: directory
    mode: 0755

- name: copy config to user home
  copy:
    src: /root/.kube/config
    dest: /root/.kube/config
    remote_src: yes
    owner: "{{ user }}"

- name: copy cluster join command
  copy:
    src: /tmp/cluster_join_command.sh
    dest: /home/{{ user }}/cluster_join_command.sh
    mode: 0777

- name: execute cluster join command
  shell: /home/{{ user }}/cluster_join_command.sh
  register: joined

# print if join command was successful in console
- debug:
    msg: "{{ joined.stdout }}"
